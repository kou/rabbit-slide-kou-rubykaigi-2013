原稿

ライブラリ開発者になろう

はじめまして。クリアコードの須藤といいます。みなさん、クリアコードという会社を知っていますか？RubyKaigi 2013のシルバースポンサーをしている会社の1つです。

今日は、みなさんにライブラリー開発者になって欲しいなぁ、という話をします。これば、私自身、いろいろなライブラリーを開発してきて、ライブラリーを開発することで得られたことがたくさんあったなぁと思うからです。そして、それはみなさんにとっても役に立つことだと思います。今日話すことは私がライブラリーを開発してきて得られたことのエッセンスです。

大まかにいうとこのような順に話します。

まず、1つ例をだしながら今回の話のゴールを説明します。私が設定したゴールを、聴いているみなさんと共有できるとここでの話は成功です。

次に、共有したゴールを実現するためにキーとなる考えを説明します。これは、私がいろいろなライブラリーを開発している中で得られた考えです。

その後、いくつかの例に対してキーとなる考えを適用していきます。ここで、キーとなる考えで何をしようとしているかを聴いているみなさんがピンときたら成功です。

これで一通り説明が済んだのでおさらいします。聴いているみなさんが再確認できればいいなぁと思います。

最後に、ライブラリー開発者になった後のことについて少しだけ匂わしておしまいです。このとき、みなさんがいい話だったなぁという顔をしていれば、ここで「最後まで話を聴いてくれてありがとうございます」というはずです。

それでは、例を出しながら今日の話のゴールを説明します。

まず、今日の話のゴールです。ゴールは「よりよいソフトウェアを開発するための方法をみなさんが知ること」です。このゴールを私と共有できそうですか？私はそのゴールを達成するためにこれから簡単な例をだしながら説明します。みなさんはこの方法は本当によりよいソフトウェアを開発する方法だろうかと自分の経験も踏まえながら考えてください。よりよいソフトウェアとはどんなソフトウェアか、それを開発するにはどうしたらよいかを考えるきっかけになるとうれしいです。

それでは、まずはよりよいソフトウェアとはどんなソフトウェアかを例を見ながら考えてみましょう。どうやって開発するかはよりよいソフトウェアはどんなソフトウェアかを考えてからです。

こんなAPIがあります。これはrcairoというライブラリーのAPIです。rcairoはcairoというグラフィックスライブラリーのRubyバインディングです。rcairoは私が開発しています。このRabbitというプレゼンソフトも私が開発しているのですが、Rabbitでもrcairoを使っています。

saveで現在の描画情報を保存しておいてrestoreでsaveした状態まで戻します。描画情報とはどのように線を書くか線の太さとかそういうやつです。間にあるcircleとstrokeで円を書いています。

では、これをもっとよくするためにはどうしたらよいでしょうか。「もっとよい」の基準は人それぞれですが、まずは自分の「もっとよい」の基準で考えてみてください。「もっとよい」の指針のひとつは後で説明します。

saveとrestoreに注目してみるとどうでしょうか。

ここに注目するとブロックを使った書き方が思いつきます。こちらの方がよりよいAPIです。

では、どうしてブロックを使ったほうがよりよいAPIなのでしょうか？それは、よりRubyらしい書き方だからです。「Rubyらしい」とはどういうことでしょうか？「○○らしい」とは「他と似ている」ということです。「Rubyらしい」書き方だとまわりのコードと似たような記述になります。つまり、まわりのコードと統一感が出るということです。統一感がでると読みやすくなります。読みやすくなるとメンテナンスが楽になるため開発を継続するためにはよりよいことです。よって、「Rubyらしい書き方」がよりよい基準のひとつです。

では、このブロックの使い方は「Rubyらしい」のでしょうか。Fileクラスを思い出してください。Fileクラスではopenでファイルを開いています。これは準備処理です。readして使い終わったら閉じています。これは後始末です。

ただ、このように明示的にcloseを書くのはRuby初心者です。Rubyに慣れた人はこのようにブロックを使って書きます。こうすることの利点は2つです。1つはcloseのし忘れがなくなるということです。もう1つは具体的にどう後処理をしなければいけないかを意識しなくてもよくなるということです。ファイルの場合の後処理はcloseで、Dir.chdirのときは元のディレクトリーに戻る、などと使い分ける必要はありません。ブロックを抜けたら「いい感じ」に後処理をしてくれます。これが、Rubyの組み込みライブラリーで使われている後処理のためにブロックを使う方法です。つまり、これと「似た」使い方をすれば「Rubyらしい」ということです。

では、もう一度rcairoの例を見てみましょう。saveが準備処理の部分、ブロックを抜けたところで実行するrestoreは後処理の部分です。Fileと「似た」使い方ですね。ということで「Rubyらしい」と言えます。

おさらいします。「よりよい」の基準の1つは「Rubyらしい」ということです。言い換えると「他と似ている」ということです。今日の話のゴールを覚えていますか？「よりよいソフトウェアを開発するための方法をみなさんが知ること」です。いいかえると、「似ているとはどういうことかを知って、それと同じようにすること」です。

私が設定したゴールを共有できましたか？共有できていれば、ここまでの話は成功です。

まぁ、成功している体で次の話にいきます。。。

次は、このゴールを実現するためのキーとなる考えを説明します。

キーとなる考えは、「想像するんじゃなくて思い出す」です。

「想像すること」は難しいことです。これはまだ知らないことだからです。

ちなみに、多くのプログラマーは他の人のことを想像して行動することが苦手です。 ;-p

では、「思い出すこと」はどうでしょうか？これは、簡単なことです。すでに知っていることですから。ただし、知っていても忘れてしまうと思い出せません。

ちなみに、日本の多くのRubyistは待ち合わせ時間を思い出せません。 ;-p

では、思い出せるようにするにはどうしたらよいかというと、知ることです。知るためには自分で経験する方法、人から聞く方法、観察して学ぶ方法などがあります。この中でも一番初めにやることは経験してみることです。経験すれば知っているので思い出せるようになります。

ということで、キーとなる考えは「想像するんじゃなくて思い出す」です。

では、このキーとなる考えを適用してみましょう。

まず、このキーとなる考えで実現したいゴールの再確認です。ゴールは「よりよいソフトウェアを開発するための方法をみなさんが知ること」でしたね。

では、このゴールを実現するために何を経験すればいいでしょうか。それは、「Rubyユーザー」としての経験です。これは、すでにみなさん経験していますよね！

では、実際にその経験を活かしてみましょう。

これは、Ruby/GTK2というライブラリーのAPIです。Ruby/GTK+はGTK+というGUIツールキットのRubyバインディングです。Ruby/GTK2も私が開発しています。このプレゼンソフトでも使っています。

windowオブジェクトのopacityプロパティを取得しています。opacityとは透明度ですね。では、これをどうすればよりよいAPIになるか考えてみてください。よりよりAPIとはRubyらしいAPIでしたね。どうすればよりRubyらしいAPIになるでしょうか。

（15秒くらい待つ。）

よりよいAPIとしてopacityというメソッドを提供しています。オブジェクトのプロパティを取得するためにプロパティ名のメソッドを使うというのはRubyではよくやる方法なのでRubyらしいです。プロパティを属性と言い換えるとわかりやすいかもしれません。attr_readerというそのためのショートカットも用意されています。

ところで、みなさんは、今、よりよいAPIを考えられましたか？「思い出す」って「難しいじゃん」って思いませんでしたか？そう、難しいんです。「思い出せ！？」「Rubyらしいって何！？」

すでに知っているはずなのにどうして思い出すことが難しいんでしょう。それは、「想像するんじゃなくて思い出す」という経験をしていないからです。今、みなさんは経験したんじゃなくて「聞いただけ」という状態です。

それでは、もう一度。ゴールを実現するためには何を経験したらよいのでしょうか。それは、ライブラリー開発者としての経験です。ここでようやくこの話のタイトルがでてきました。

ライブラリー開発者はRubyユーザーとして使いやすいAPIとはどういうAPIだろうと考えたり、ライブラリーのユーザーとしてわかりやすいドキュメントはどんなドキュメントだろう、ということを考えます。他にもいろいろ考えます。そして、これらを何度も何度も考えます。考える機会がたくさんあるのです。「たくさん」というのはとてもよい練習になります。なので、「想像するんじゃなくて思い出す」をうまくやるためにはライブラリー開発者になることがおすすめです。

それでは、APIとドキュメントの例を考えてみましょう。まずはAPIです。プロパティの値を取得するにはプロパティ名と同じメソッドを用意するのがRubyらしいのでしたね。それでは、visibleというプロパティという場合はどうでしょう。ヒントはvisibleは真偽値を返すということです。

（15秒くらい待つ）

Rubyらしくするならメソッド名の最後に「?」をつけますね。

では、なんでもメソッド名にすればよいのでしょうか？この例ではどうでしょう。ここのrecordはテーブルの中の1つのレコードです。このレコードのカラムの値にアクセスするにはHashのようにアクセスするのとメソッドでアクセスするのはどっちがよいでしょうか？レコードをコレクションと捉えるならHashのようにアクセスするのがRubyらしいですし、オブジェクトとして捉えるならメソッドでアクセスするのがRubyらしいですね。

ドキュメントについても考えてみましょう。

Ruby/GTK2は拡張ライブラリなので事前にGTK+というCのライブラリーをインストールしておく必要があります。ユーザーのことを考えるとドキュメントにはその旨を書いておかないと、となります。でも、これでよいのでしょうか？よりよいドキュメントならこうするべきです。gemをインストールするときはgem install GEM名が普通のやり方です。これがRubyGemsらしさです。普通はこれでインストールするなら、これでインストールできるようにするべきなのです。Ruby/GTK2はgem install gtk2とやったら必要なパッケージを自動でインストールするようにして、インストールドキュメントはgem install gtk2だけにしています。

ということで、実際に「想像するんじゃなくて思い出す」というキーとなる考えを適用してみました。ピンときましたか？

まとめます。この話のゴールは「よりよいソフトウェアを開発するための方法をみなさんが知ること」でした。「よりよい」とは「Rubyらしい」、言い換えると「他と似ている」ということです。これを実現するためのキーとなる考えが「想像するんじゃなくて思い出す」というものです。なぜなら想像するのは知らないので難しく、思い出すのは知っているので簡単だからです。ソフトウェア開発に当てはめてみると、思い出すためにはライブラリーユーザーとしての経験が必要です。あとはその経験を思い出せばいいのです。しかし、「思い出す」という経験がないので「思い出す」ことが難しいことでしょう。「思い出す」経験をするためにはライブラリー開発者になることをおすすめします。ライブラリーを開発すると何度も何度も「思い出す」必要があり、とてもよい練習になります。という話をしました。

最後にライブラリー開発者になった後の話をして終わりにします。

「ライブラリー開発者」としての経験を他のことにも使ってください。たとえば、他のソフトウェアの開発に使ってください。Rubyでもいいです。他のソフトウェアを開発するときには、よりよいバグレポートはどうすればいいだろうとか、よいパッチになるコミットとはどうすればいいだろうとかを「思い出して」ください。例えば、バグレポートなら再現方法があるとうれしいですし、期待する結果もあるとうれしいですね。ライブラリー開発者としてバグレポートをもらった経験を思い出せばいろいろわかるはずです。

ということで、ライブラリー開発者になりましょう！

参考までに。。。

クリアコードというシルバースポンサーな会社はインターンシップへの応募を受け付けています。このインターンシップではクリアコードのメンバーとライブラリーを開発します。よりよいソフトウェアを開発するためのよい経験になるはずなので、ぜひ検討してみてください。

このとき、みなさんがいい話だったなぁという顔をしていれば、ここで「最後まで話を聴いてくれてありがとうございます」というはずです。
